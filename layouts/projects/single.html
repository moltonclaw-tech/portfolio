{{ define "main" }}
<article class="project-detail">
    {{ if and .Params.content (gt (len .Params.content) 0) }}
    {{ $first := index .Params.content 0 }}
    <header class="project-header">
        <div class="project-header-bg">
            {{ if eq $first.type "image" }}
            {{ $img := resources.Get $first.src }}
            {{ if $img }}
              {{ $large := $img.Resize "2000x webp" }}
              <img src="{{ $large.RelPermalink }}" alt="{{ $.Title }}" class="project-header-image" loading="lazy">
            {{ else }}
              <img src="{{ $first.src }}" alt="{{ $.Title }}" class="project-header-image" loading="lazy">
            {{ end }}
            {{ end }}
        </div>
        <div class="project-header-overlay"></div>
        <div class="project-header-fade"></div>
        <h1 class="project-header-title">{{ $.Title }}</h1>
    </header>
    {{ end }}

    <div class="project-content">

        {{/* Content - Images & Videos in specified order */}}
        {{ range $index, $item := .Params.content }}
            {{ if eq .type "image" }}
        {{ $img := resources.Get .src }}
        {{ if $img }}
          {{ $small := $img.Resize "800x webp" }}
          {{ $medium := $img.Resize "1200x webp" }}
          {{ $large := $img.Resize "2000x webp" }}
          {{ $lqip := $img.Resize "30x webp" | images.Filter (images.GaussianBlur 3) }}
          
          <figure class="project-image">
            <img 
              src="{{ $small.RelPermalink }}"
              srcset="{{ $small.RelPermalink }} 800w, {{ $medium.RelPermalink }} 1200w, {{ $large.RelPermalink }} 2000w"
              sizes="(max-width: 800px) 100vw, 1200px"
              data-src="{{ $large.RelPermalink }}"
              data-lqip="{{ $lqip.RelPermalink }}"
              alt="{{ $.Title }}"
              class="lazy"
              width="{{ $small.Width }}"
              height="{{ $small.Height }}"
              loading="lazy"
            >
          </figure>
        {{ else }}
          <figure class="project-image">
            <img src="{{ .src }}" alt="{{ $.Title }}" loading="lazy">
          </figure>
        {{ end }}
            {{ else if eq .type "video" }}
        <div class="project-video">
            {{ if hasPrefix .url "http" }}
                {{ if in .url "youtube.com" }}
                {{ $parts := split .url "/" }}
                {{ $videoId := index $parts (sub (len $parts) 1) }}
                <iframe src="https://www.youtube.com/embed/{{ $videoId }}" frameborder="0" allowfullscreen loading="lazy"></iframe>
                {{ else if in .url "youtu.be" }}
                {{ $videoId := replace .url "https://youtu.be/" "" }}
                <iframe src="https://www.youtube.com/embed/{{ $videoId }}" frameborder="0" allowfullscreen loading="lazy"></iframe>
                {{ else if in .url "vimeo.com" }}
                {{ $parts := split .url "/" }}
                {{ $videoId := index $parts (sub (len $parts) 1) }}
                <iframe src="https://player.vimeo.com/video/{{ $videoId }}" frameborder="0" allowfullscreen loading="lazy"></iframe>
                {{ else }}
                <video controls loading="lazy">
                    <source src="{{ .url }}" type="video/mp4">
                </video>
                {{ end }}
            {{ else }}
            <video controls loading="lazy">
                <source src="{{ .url | relURL }}" type="video/mp4">
            </video>
            {{ end }}
        </div>
            {{ end }}
        {{ end }}

        {{/* Project Info */}}
        <aside class="project-info">
            <h2 class="project-title">{{ .Title }}</h2>

            {{ with .Description }}
            <p class="project-description">{{ . | markdownify }}</p>
            {{ end }}

            <div class="project-meta">
                {{ with .Params.year }}
                <div class="meta-item">
                    <span class="meta-label">Year</span>
                    <span class="meta-value">{{ . }}</span>
                </div>
                {{ end }}
            </div>

            {{ with .Params.tools }}
            <div class="project-tools">
                <h3>Tools Used</h3>
                <ul class="tools-list">
                    {{ range . }}
                    <li>{{ . }}</li>
                    {{ end }}
                </ul>
            </div>
            {{ end }}
        </aside>

    </div>

    <nav class="project-nav">
        {{ with .PrevInSection }}
        <a href="{{ .Permalink }}" class="nav-prev">&larr; {{ .Title }}</a>
        {{ end }}
        {{ with .NextInSection }}
        <a href="{{ .Permalink }}" class="nav-next">{{ .Title }} &rarr;</a>
        {{ end }}
    </nav>
</article>

<script>
// Blur-up lazy loading for project images
document.addEventListener('DOMContentLoaded', function() {
    const lazyImages = document.querySelectorAll('img.lazy');
    
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                const src = img.dataset.src;
                const lqip = img.dataset.lqip;
                
                if (lqip && !img.src.includes(lqip)) {
                    img.style.transition = 'opacity 0.5s ease-in-out';
                    img.style.opacity = '0.4';
                }
                
                img.src = src;
                img.onload = function() {
                    if (lqip) {
                        img.style.opacity = '1';
                    }
                    img.classList.remove('lazy');
                };
                
                observer.unobserve(img);
            }
        });
    });
    
    lazyImages.forEach(img => imageObserver.observe(img));
});
</script>
{{ end }}
