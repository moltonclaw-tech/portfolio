<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Admin</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: sans-serif; background: #1a1a1a; color: #fff; display: flex; height: 100vh; }
        .sidebar { width: 200px; background: #252525; border-right: 1px solid #333; padding: 10px; }
        .sidebar h2 { font-size: 14px; margin-bottom: 10px; }
        .proj { padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #2a2a2a; font-size: 12px; }
        .proj:hover { background: #333; }
        .proj.active { background: #de8553; color: #000; }
        .main { flex: 1; padding: 20px; overflow: auto; }
        .field { margin-bottom: 10px; }
        .field label { display: block; font-size: 10px; color: #888; margin-bottom: 3px; }
        .field input, .field select { width: 100%; padding: 8px; background: #333; border: 1px solid #444; color: #fff; }
        .section { margin-top: 20px; }
        .section h3 { font-size: 11px; color: #de8553; margin-bottom: 8px; }
        .tags, .tools { display: flex; flex-wrap: wrap; gap: 5px; }
        .tag { padding: 4px 8px; background: #333; border-radius: 10px; font-size: 11px; cursor: pointer; }
        .tag.on { background: #de8553; color: #000; }
        #preview { width: 100%; height: 500px; border: none; background: #1f1c1a; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Projects</h2>
        <div id="list"></div>
    </div>
    
    <div class="main">
        <h2 id="currentProject">Select a project</h2>
        <br>
        <div id="editor" style="display:none">
            <div class="field">
                <label>Title</label>
                <input type="text" id="title">
            </div>
            <div class="field">
                <label>Description</label>
                <input type="text" id="desc">
            </div>
            <div class="field">
                <label>Year</label>
                <input type="text" id="year">
            </div>
            <div class="field">
                <label>Importance</label>
                <select id="imp">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
            </div>
            <div class="field">
                <label>Thumbnail</label>
                <select id="thumb"></select>
            </div>
            
            <div class="section">
                <h3>Tags</h3>
                <div class="tags" id="tagList"></div>
            </div>
            
            <div class="section">
                <h3>Tools</h3>
                <div class="tools" id="toolList"></div>
            </div>
            
            <div class="section">
                <h3>Preview</h3>
                <iframe id="preview"></iframe>
            </div>
        </div>
    </div>
    
    <script>
        let projects = [];
        let currentProject = null;
        
        let projectData = {};
        
        const allTags = ['character', 'zbrush', 'game-ready', 'miniature', 'creature', 'horror', 'concept', 'blender', 'maya', 'substance'];
        const allTools = ['ZBrush', 'Blender', 'Maya', 'Substance Painter', 'Substance Designer', 'Arnold', 'Keyshot', 'Marmoset'];
        
        async function init() {
            // Load project list
            const r = await fetch('/projects/');
            const html = await r.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const links = doc.querySelectorAll('a');
            
            projects = [];
            links.forEach(link => {
                const href = link.getAttribute('href');
                if (href && href.startsWith('/projects/') && href !== '/projects/' && !href.includes('.')) {
                    const name = href.replace('/projects/', '').replace('/', '');
                    if (!projects.includes(name)) projects.push(name);
                }
            });
            
            document.getElementById('list').innerHTML = projects.map(p => 
                '<div class="proj" onclick="selectProject(\'' + p + '\')">' + p.replace(/-/g, ' ') + '</div>'
            ).join('');
        }
        
        async function selectProject(name) {
            currentProject = name;
            
            // Update sidebar active state
            document.querySelectorAll('.proj').forEach((el, i) => {
                el.classList.toggle('active', projects[i] === name);
            });
            
            document.getElementById('currentProject').textContent = name.replace(/-/g, ' ');
            document.getElementById('editor').style.display = 'block';
            
            // Fetch project markdown
            const r = await fetch('/projects/' + name + '/');
            const html = await r.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const code = doc.querySelector('pre code');
            
            if (code) {
                const content = code.textContent;
                const parts = content.split('---');
                const frontmatter = parts[1] || '';
                
                // Parse fields
                projectData.title = (frontmatter.match(/title:\s*(.+)/) || ['',''])[1].replace(/"/g, '').trim();
                projectData.desc = (frontmatter.match(/description:\s*(.+)/) || ['',''])[1].replace(/"/g, '').trim();
                projectData.year = (frontmatter.match(/year:\s*(.+)/) || ['',''])[1].trim();
                projectData.imp = (frontmatter.match(/importance:\s*(.+)/) || ['','3'])[1].trim();
                projectData.thumb = (frontmatter.match(/thumbnail:\s*(.+)/) || ['',''])[1].replace(/"/g, '').trim();
                
                // Parse tags
                const tagsMatch = frontmatter.match(/tags:\s*\n((?:\s+-.+\n?)*)/);
                projectData.tags = tagsMatch ? tagsMatch[1].split('\n').map(s => s.match(/- "(.+)"/)?.[1] || s.match(/- (.+)/)?.[1]).filter(Boolean) : [];
                
                // Parse tools
                const toolsMatch = frontmatter.match(/tools:\s*\n((?:\s+-.+\n?)*)/);
                projectData.tools = toolsMatch ? toolsMatch[1].split('\n').map(s => s.match(/- "(.+)"/)?.[1] || s.match(/- (.+)/)?.[1]).filter(Boolean) : [];
                
                // Fill form
                document.getElementById('title').value = projectData.title;
                document.getElementById('desc').value = projectData.desc;
                document.getElementById('year').value = projectData.year;
                document.getElementById('imp').value = projectData.imp || 3;
                
                // Render tags
                document.getElementById('tagList').innerHTML = allTags.map(t => 
                    '<span class="tag ' + (projectData.tags.includes(t) ? 'on' : '') + '" onclick="toggleTag(\'' + t + '\')">' + t + '</span>'
                ).join('');
                
                // Render tools
                document.getElementById('toolList').innerHTML = allTools.map(t => 
                    '<span class="tag ' + (projectData.tools.includes(t) ? 'on' : '') + '" onclick="toggleTool(\'' + t + '\')">' + t + '</span>'
                ).join('');
            }
            
            // Load thumbnails
            const r2 = await fetch('/projects/' + name + '/');
            const html2 = await r2.text();
            const doc2 = new DOMParser().parseFromString(html2, 'text/html');
            const links2 = doc2.querySelectorAll('a');
            const imgs = [];
            links2.forEach(l => {
                const h = l.getAttribute('href') || '';
                if (h.match(/\.(jpg|jpeg|png|gif)$/i)) imgs.push(h.split('/').pop());
            });
            
            document.getElementById('thumb').innerHTML = '<option value="">--</option>' + 
                imgs.map(i => '<option value="' + i + '">' + i.substring(0, 30) + '</option>').join('');
            document.getElementById('thumb').value = projectData.thumb;
            
            // Preview
            document.getElementById('preview').src = '/projects/' + name + '/';
        }
        
        function toggleTag(t) {
            if (projectData.tags.includes(t)) {
                projectData.tags = projectData.tags.filter(x => x !== t);
            } else {
                projectData.tags.push(t);
            }
            document.getElementById('tagList').innerHTML = allTags.map(tg => 
                '<span class="tag ' + (projectData.tags.includes(tg) ? 'on' : '') + '" onclick="toggleTag(\'' + tg + '\')">' + tg + '</span>'
            ).join('');
            save();
        }
        
        function toggleTool(t) {
            if (projectData.tools.includes(t)) {
                projectData.tools = projectData.tools.filter(x => x !== t);
            } else {
                projectData.tools.push(t);
            }
            document.getElementById('toolList').innerHTML = allTools.map(tg => 
                '<span class="tag ' + (projectData.tools.includes(tg) ? 'on' : '') + '" onclick="toggleTool(\'' + tg + '\')">' + tg + '</span>'
            ).join('');
            save();
        }
        
        async function save() {
            const md = `---
title: "${projectData.title}"
date: "${new Date().toISOString().split('T')[0]}"
type: projects
description: "${projectData.desc}"
tags: [${projectData.tags.map(t => '"' + t + '"').join(',')}]
importance: ${document.getElementById('imp').value}
thumbnail: "${document.getElementById('thumb').value}"

year: ${projectData.year || new Date().getFullYear()}
tools: [${projectData.tools.map(t => '"' + t + '"').join(',')}]

---

${projectData.desc}
`;
            
            await fetch('/admin/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({project: currentProject, content: md})
            });
        }
        
        init();
    </script>
</body>
</html>
